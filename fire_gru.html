<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wildfire | GRU + Hazard RNN â€” Interactive Report</title>
  <meta name="description" content="GRU ignition forecasting (k=7/14) with spatial prior + hazard RNN. History-safe features; region Ã— latitude-band diagnostics; interactive summaries." />
  <style>
    :root{
      --bg:#f9fafb; --panel:#ffffff; --ink:#111827; --ink-2:#4b5563; --muted:#9ca3af; --accent:#2563eb; --soft:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:sticky;top:0;z-index:10;background:rgba(249,250,251,0.92);backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--soft);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:0 16px}
    .nav{display:flex;align-items:center;justify-content:space-between;height:56px}
    .nav h1{font-size:18px;margin:0}
    .nav ul{list-style:none;margin:0;padding:0;display:flex;gap:14px}
    .nav li a{display:inline-block;padding:6px 8px;border-radius:8px}
    .nav li a:hover{background:#eef2ff}
    section{padding:22px 0;border-top:1px solid var(--soft)}
    h2{margin:0 0 12px 0;font-size:24px}
    h3{margin:0 0 10px 0;font-size:20px}
    .muted{color:var(--ink-2)}
    .small{font-size:12px;color:var(--muted)}
    .hint{color:var(--ink-2); margin-top:6px}
    .hero{padding:26px 0 8px 0}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--soft);border-radius:999px;font-size:12px;margin-right:6px;background:#fff}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:980px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:12px; position:relative;}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .card-title{font-weight:600}
    .iframe-full iframe{width:100%;height:520px;border:0;border-radius:8px;background:#fff}
    /* actions on cards */
    .actions{position:absolute; top:8px; right:10px; display:flex; gap:6px}
    .actions button, .actions a{font-size:12px; padding:4px 8px; border:1px solid var(--soft); border-radius:8px; background:#fff; color:#111827; text-decoration:none}
    /* per-region viewer */
    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:8px 0 14px 0}
    @media (max-width:980px){.controls{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--ink-2);display:block;margin-bottom:6px}
    select{width:100%;padding:10px;border:1px solid var(--soft);border-radius:10px;background:#fff}
    .img-panel{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:980px){.img-panel{grid-template-columns:1fr}}
    .imgbox{background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:8px;text-align:center}
    .imgbox img{max-width:100%;height:auto;border-radius:8px}
    footer{padding:22px 0;color:var(--muted)}
    /* fullscreen overlay for iframes */
    #fsPanel{ position:fixed; inset:0; background:rgba(0,0,0,.75); display:none;
      align-items:center; justify-content:center; z-index:9999; }
    #fsPanel .frame{ width:95vw; height:90vh; background:#fff; border-radius:10px; border:0; }
    #fsPanel .close{ position:absolute; top:14px; right:18px; padding:6px 10px; background:#fff; border-radius:8px; border:1px solid #e5e7eb; }

    /* Image zoom overlay for per-region PNGs (added) */
    .imgbox img{ cursor: zoom-in; }
    #imgFs{
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:none; align-items:center; justify-content:center; z-index:10000;
    }
    #imgFs img{ max-width:95vw; max-height:92vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    #imgFs .close{ position:absolute; top:14px; right:18px; padding:6px 10px; background:#fff; border-radius:8px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<header>
  <div class="wrap nav">
    <h1>Wildfire â€” GRU + Hazard RNN</h1>
    <nav>
      <ul>
        <li><a href="#findings">Main findings</a></li>
        <li><a href="#viewer">Perâ€‘region</a></li>
        <li><a href="#interactive">Interactive</a></li>
        <li><a href="#methods">Methods</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- ===== 1) Main findings ===== -->
  <section class="hero" id="findings">
    <h2>Main findings</h2>
    <p class="muted">
      Daily grid (10â€“15 kmÂ²), historyâ€‘safe features; GRU predicts whether a new fire occurs within <span class="pill">k=7</span><span class="pill">k=14</span> days.
      Learned spatial ignition prior used as timeâ€‘varying features; postâ€‘fire reâ€‘ignition analyzed with discreteâ€‘time hazard.
    </p>
    <div class="grid cols-2">
      <div class="card">
        <div class="card-header"><div class="card-title">Overall performance</div></div>
        <ul class="muted">
          <li>k=14 + prior is wellâ€‘calibrated in most regions; PRâ€‘AUC and gain curves clearly stronger in mid/highâ€‘fire regions.</li>
          <li>Strong: West_Mid, West_North, Coast_Mid, CentralWest_Mid+South_COMBINED.</li>
          <li>Weaker: CentralWest_South, Midwest_South and other lowâ€‘fire regions.</li>
        </ul>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Benefit of the spatial prior</div></div>
        <ul class="muted">
          <li>k=14: with_prior vs no_prior â†’ ROCâ€‘AUC +0.02 to +0.03 on average.</li>
          <li>Topâ€‘3% precision usually +0.03â€“0.08 (a few regions slightly down).</li>
        </ul>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Topâ€‘3% (k=14, with_prior)</div></div>
        <ul class="muted">
          <li>Median precision â‰ˆ 0.36; â‰ˆ42% of regions â‰¥ 0.40; â‰ˆ29% â‰¥ 0.50.</li>
        </ul>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Operating points</div></div>
        <ul class="muted">
          <li>k=14 with regionâ€‘specific thresholds (target â‰ˆ30% precision).</li>
          <li>Precision ~0.30â€“0.45 in mid/highâ€‘fire regions; lift typically 1.5â€“3Ã— base rate.</li>
        </ul>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">k=7 vs k=14</div></div>
        <ul class="muted"><li>ROCâ€‘AUC highly correlated; mean difference small (k=14 slightly lower).</li></ul>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Hazard (reâ€‘ignition)</div></div>
        <ul class="muted">
          <li>West_Mid fast; many other regions slower (P(Tâ‰¤60) â‰ˆ 0.10â€“0.25).</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ===== 2) Perâ€‘region diagnostics viewer ===== -->
  <section id="viewer">
    <h2>Perâ€‘region diagnostics viewer</h2>
    <p class="muted">Pick a region, latitude band, horizon, and whether the GRU uses the spatial ignition prior. Three diagnostics will load: PR/ROC/calibration, score histogram, and gain & lift curves.</p>

    <div class="controls">
      <div><label for="region">Region</label><select id="region"></select></div>
      <div><label for="lat">Lat zone</label><select id="lat"></select></div>
      <div><label for="k">Horizon k</label>
        <select id="k"><option value="7">7</option><option value="14" selected>14</option></select></div>
      <div><label for="prior">Prior</label>
        <select id="prior"><option value="with_prior" selected>with spatial prior</option><option value="no_prior">no prior</option></select></div>
    </div>

    <div class="small" id="hint"></div>

    <div class="img-panel">
      <div class="imgbox">
        <img id="imgA" alt="PR/ROC/Calibration plot" onerror="this.alt='Image not found (PR/ROC/Calibration)'; this.style.opacity=0.5;">
        <div class="small">PRâ€‘ROCâ€‘Reliability</div>
      </div>
      <div class="imgbox">
        <img id="imgB" alt="Score histogram" onerror="this.alt='Image not found (score histogram)'; this.style.opacity=0.5;">
        <div class="small">Score histogram</div>
      </div>
      <div class="imgbox">
        <img id="imgC" alt="Gain & Lift curves" onerror="this.alt='Image not found (gain & lift)'; this.style.opacity=0.5;">
        <div class="small">Gain & lift</div>
      </div>
    </div>
  </section>

  <!-- ===== 3) Interactive summaries ===== -->
  <section id="interactive">
    <h2>Interactive summaries</h2>
    <div class="grid cols-2">
      <div class="card">
        <div class="actions"><button type="button" data-fs="gru_pr_curves.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="gru_pr_curves.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">PR overlays (k=14, with prior)</div></div>
        <div class="iframe-full"><iframe src="gru_pr_curves.html" title="PR overlays (k=14 with prior)"></iframe></div>
        <div class="hint small">ğŸ’¡ Legend is interactive: <strong>click</strong> a region to hide/show; <strong>doubleâ€‘click</strong> to isolate; <strong>doubleâ€‘click background</strong> to reset. Use toolbar to pan/boxâ€‘zoom and <em>Autoscale</em> to reset.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="gru_summary.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="gru_summary.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Summary metrics (PRâ€‘AUC / ROCâ€‘AUC / base)</div></div>
        <div class="iframe-full"><iframe src="gru_summary.html" title="GRU summary table & charts"></iframe></div>
        <div class="hint small">ğŸ’¡ Click legend items to toggle series; use toolbar icons for zoom/pan; <em>Autoscale</em> resets the view.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="operating_points.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="operating_points.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Operating points (k=14 & k=7)</div></div>
        <div class="iframe-full"><iframe src="operating_points.html" title="Operating points"></iframe></div>
        <div class="hint small">ğŸ’¡ Toggle k=7/k=14 traces in the legend; doubleâ€‘click to focus on one.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="delta_top3.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="delta_top3.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Topâ€‘3% precision gains (with vs no prior)</div></div>
        <div class="iframe-full"><iframe src="delta_top3.html" title="Topâ€‘3% precision gain"></iframe></div>
        <div class="hint small">ğŸ’¡ Toggle <em>with_prior</em> / <em>no_prior</em> in the legend; use boxâ€‘zoom if xâ€‘axis labels are dense.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="gain_overlay.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="gain_overlay.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Gain overlay â€” coverage vs recall</div></div>
        <div class="iframe-full"><iframe src="gain_overlay.html" title="Gain overlay â€” coverage vs recall"></iframe></div>
        <div class="hint small">ğŸ’¡ Use the left panel inside the chart to <strong>select regions</strong> and switch between <strong>k=7/14</strong>; the Plotly toolbar still supports pan/zoom.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="hazard_waiting.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="hazard_waiting.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Median interâ€‘fire waiting time</div></div>
        <div class="iframe-full"><iframe src="hazard_waiting.html" title="Median waiting time"></iframe></div>
        <div class="hint small">ğŸ’¡ Click legend to toggle series; use boxâ€‘zoom to examine specific regions.</div>
      </div>

      <div class="card">
        <div class="actions"><button type="button" data-fs="hazard_cumprob.html">ğŸ” Zoom</button><a target="_blank" rel="noopener" href="hazard_cumprob.html">â†— Open</a></div>
        <div class="card-header"><div class="card-title">Reâ€‘ignition probability â‰¤30/60 days</div></div>
        <div class="iframe-full"><iframe src="hazard_cumprob.html" title="Cumulative reâ€‘ignition probability"></iframe></div>
        <div class="hint small">ğŸ’¡ Toggle 30â€‘day vs 60â€‘day bars in the legend; <strong>doubleâ€‘click</strong> a legend item to isolate.</div>
      </div>
    </div>
    <p class="small">If an iframe does not render, make sure these HTML files are at the repository root and same origin (GitHub Pages handles this).</p>
  </section>

  <!-- ===== 4) Methods ===== -->
  <section id="methods">
    <h2>Methods (summary)</h2>
    <div class="card">
      <ul>
        <li>Data: fixed grid (10â€“15 kmÂ²); daily wildfire indicator âˆˆ{0,1} + sameâ€‘day physical covariates; all features are historyâ€‘safe.</li>
        <li>Features: 1â€‘day lags; 7â€“30â€‘day rolling mean/sum/extrema; 30â€‘day â€œdryness counterâ€; CatBoost ignition prior and derived features (logit, rank, short lags, 7â€‘day rolling).</li>
        <li>Time split: expanding window (train 2013â€“2021, val 2022, test 2023â€“2025); Â±7 days removed around 2021/2022 and 2022/2023; temperature scaling on validation.</li>
        <li>GRU: singleâ€‘layer + sigmoid; target <code>y_t^k = 1{fire in [t+1, t+k]}</code>; weighted BCE; early stopping on PRâ€‘AUC.</li>
        <li>Evaluation: PR/ROC, Brier & BSS, reliability, gain/lift; decisionsâ€”fixed precision (e.g., 30%) or Topâ€‘K (0.1â€“0.2% of cells).</li>
        <li>Hazard: 3â€‘day merge window for episodes; discreteâ€‘time risk set pooled by region Ã— lat_zone; outputs <code>h(t), S(t), P(Tâ‰¤Â·)</code> and tiering.</li>
      </ul>
      <p class="small">Calibration fitted on 2022, evaluated on 2023â€“2025; <code>alerts_per_fire</code> â‰ˆ alerts needed to catch one fire (at chosen coverage).</p>
    </div>
  </section>

  <footer><p>Built for sta160â€‘wildfire Â· Static files, deployable on GitHub Pages</p></footer>
</main>

<!-- image fullscreen overlay (added) -->
<div id="imgFs"><button class="close">Close (Esc)</button><img alt=""></div>

<!-- fullscreen overlay for iframes (existing) -->
<div id="fsPanel">
  <button class="close">Close (Esc)</button>
  <iframe class="frame"></iframe>
</div>

<noscript>Enable JavaScript to use the perâ€‘region viewer and zoom panel.</noscript>

<script>
/* 1) Region/Lat config */
const REGION_LAT_CONFIG = [
  {tag:"CentralWest_FarNorth", region:"CentralWest", lat:"FarNorth"},
  {tag:"CentralWest_Mid", region:"CentralWest", lat:"Mid"},
  {tag:"CentralWest_Mid+South_COMBINED", region:"CentralWest", lat:"Mid+South_COMBINED"},
  {tag:"CentralWest_North", region:"CentralWest", lat:"North"},
  {tag:"CentralWest_South", region:"CentralWest", lat:"South"},
  {tag:"Coast_FarNorth", region:"Coast", lat:"FarNorth"},
  {tag:"Coast_Mid", region:"Coast", lat:"Mid"},
  {tag:"Coast_North", region:"Coast", lat:"North"},
  {tag:"Coast_South", region:"Coast", lat:"South"},
  {tag:"East_FarNorth", region:"East", lat:"FarNorth"},
  {tag:"East_Mid", region:"East", lat:"Mid"},
  {tag:"East_North", region:"East", lat:"North"},
  {tag:"East_NorthBand_COMBINED", region:"East", lat:"NorthBand_COMBINED"},
  {tag:"East_South", region:"East", lat:"South"},
  {tag:"Midwest_FarNorth", region:"Midwest", lat:"FarNorth"},
  {tag:"Midwest_Mid", region:"Midwest", lat:"Mid"},
  {tag:"Midwest_North", region:"Midwest", lat:"North"},
  {tag:"Midwest_South", region:"Midwest", lat:"South"},
  {tag:"NorthEast_FarNorth", region:"NorthEast", lat:"FarNorth"},
  {tag:"NorthEast_North", region:"NorthEast", lat:"North"},
  {tag:"NorthEast_NorthBand_COMBINED", region:"NorthEast", lat:"NorthBand_COMBINED"},
  {tag:"West_FarNorth", region:"West", lat:"FarNorth"},
  {tag:"West_Mid", region:"West", lat:"Mid"},
  {tag:"West_North", region:"West", lat:"North"}
];

/* 2) Dropdowns + robust image path fallback */
const selRegion = document.getElementById('region');
const selLat    = document.getElementById('lat');
const selK      = document.getElementById('k');
const selPrior  = document.getElementById('prior');
const hint      = document.getElementById('hint');

function unique(arr){ return [...new Set(arr)]; }
function regions(){ return unique(REGION_LAT_CONFIG.map(x=>x.region)).sort(); }
function latsOf(region){ return REGION_LAT_CONFIG.filter(x=>x.region===region).map(x=>x.lat); }
function tagOf(region, lat){ const item = REGION_LAT_CONFIG.find(x=>x.region===region && x.lat===lat); return item ? item.tag : null; }

function fillRegions(){ selRegion.innerHTML = regions().map(r=>`<option value="${r}">${r}</option>`).join(''); }
function fillLats(){
  const r = selRegion.value;
  const lats = unique(latsOf(r));
  selLat.innerHTML = lats.map(l=>`<option value="${l}">${l}</option>`).join('');
}

// Build candidate URLs under multiple root folders and name variants
function buildCandidates(tag, k, pr, plot){
  const fname = `${tag}_k${k}_GRU_${pr}_${plot}.png`;
  // expected roots
  const flat   = `figs/gru_region/${fname}`;
  const nested = `figs/gru_region/${tag}/figs/${fname}`;
  // your current repo: per_region/<Tag>/figs
  const perA   = `per_region/${tag}/figs/${fname}`;
  const perB   = `per_region/${tag.replace('FarNorth','Far North')}/figs/${fname.replace('FarNorth','Far North')}`;
  const perC   = `per_region/${tag.replace('_NorthBand_COMBINED','_NorthBand')}/figs/${fname.replace('_NorthBand_COMBINED','_NorthBand')}`;
  // also try spaced/band variants in figs/gru_region
  const flatSpace   = `figs/gru_region/${fname.replace('FarNorth','Far North')}`;
  const nestedSpace = `figs/gru_region/${tag.replace('FarNorth','Far North')}/figs/${fname.replace('FarNorth','Far North')}`;
  const flatBand    = `figs/gru_region/${fname.replace('_NorthBand_COMBINED','_NorthBand')}`;
  const nestedBand  = `figs/gru_region/${tag.replace('_NorthBand_COMBINED','_NorthBand')}/figs/${fname.replace('_NorthBand_COMBINED','_NorthBand')}`;
  return [flat, nested, perA, perB, perC, flatSpace, nestedSpace, flatBand, nestedBand];
}

function setWithFallback(img, urls){
  if(!urls.length){ img.alt='Image not found'; img.style.opacity=0.5; return; }
  const url = urls.shift();
  img.onerror = ()=>{ setWithFallback(img, urls); };
  console.log('[viewer] try:', url);
  img.src = url;
}

function updateImages(){
  const tag = tagOf(selRegion.value, selLat.value);
  const k   = selK.value;
  const pr  = selPrior.value;
  const plots = ['pr_roc_reliability','score_hist','gain_lift'];
  const ids   = ['imgA','imgB','imgC'];
  plots.forEach((plot, i)=>{
    const urls = buildCandidates(tag, k, pr, plot);
    setWithFallback(document.getElementById(ids[i]), urls);
  });
  hint.textContent = `Current: ${tag} Â· k=${k} Â· ${pr} (auto path fallback)`;
}

// init defaults
fillRegions(); selRegion.value = "West"; fillLats(); selLat.value = "Mid"; updateImages();
[selRegion, selLat, selK, selPrior].forEach(el=>{
  el.addEventListener('change', ()=>{ if(el===selRegion){ fillLats(); } updateImages(); });
});

/* 3) Zoom panel for iframes */
(function(){
  const panel = document.getElementById('fsPanel');
  const frame = panel.querySelector('.frame');
  function openFs(src){ frame.src = src; panel.style.display='flex'; }
  function closeFs(){ frame.src='about:blank'; panel.style.display='none'; }
  panel.querySelector('.close').onclick = closeFs;
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeFs(); });
  document.querySelectorAll('.actions [data-fs]').forEach(btn=>{
    btn.addEventListener('click', ()=> openFs(btn.getAttribute('data-fs')));
  });
})();

/* 4) Click-to-zoom for the three per-region images (added) */
(function(){
  const fs = document.getElementById('imgFs');
  if(!fs) return;
  const big = fs.querySelector('img');

  function openImg(src){ big.src = src; fs.style.display = 'flex'; }
  function closeImg(){ big.src = ''; fs.style.display = 'none'; }

  fs.querySelector('.close').onclick = closeImg;
  fs.addEventListener('click', (e)=>{ if(e.target === fs) closeImg(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeImg(); });

  ['imgA','imgB','imgC'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.addEventListener('click', ()=> openImg(el.src)); }
  });
})();
</script>
</body>
</html>